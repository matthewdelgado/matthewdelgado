/**
 * Cloudflare Pages Function - Contact Form Handler
 *
 * To use:
 * 1. Rename this file to contact.ts
 * 2. Set up an email service (Resend, SendGrid, etc.)
 * 3. Add API keys to Cloudflare Pages environment variables
 * 4. Create a contact form component that POSTs to /api/contact
 *
 * This function will be automatically deployed with your Cloudflare Pages site
 */

interface ContactFormData {
  name: string
  email: string
  message: string
}

export async function onRequestPost(context: any) {
  try {
    const { request, env } = context
    const data: ContactFormData = await request.json()

    // Validate input
    if (!data.name || !data.email || !data.message) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields' }),
        {
          status: 400,
          headers: { 'Content-Type': 'application/json' }
        }
      )
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(data.email)) {
      return new Response(
        JSON.stringify({ error: 'Invalid email address' }),
        {
          status: 400,
          headers: { 'Content-Type': 'application/json' }
        }
      )
    }

    // Example: Send email using Resend API
    // const response = await fetch('https://api.resend.com/emails', {
    //   method: 'POST',
    //   headers: {
    //     'Authorization': `Bearer ${env.RESEND_API_KEY}`,
    //     'Content-Type': 'application/json'
    //   },
    //   body: JSON.stringify({
    //     from: 'noreply@yourdomain.com',
    //     to: 'your-email@example.com',
    //     subject: `Contact from ${data.name}`,
    //     text: `
    //       Name: ${data.name}
    //       Email: ${data.email}
    //       Message: ${data.message}
    //     `
    //   })
    // })

    // Or save to database (KV, D1, etc.)
    // await env.CONTACT_SUBMISSIONS.put(
    //   `submission-${Date.now()}`,
    //   JSON.stringify(data)
    // )

    return new Response(
      JSON.stringify({
        success: true,
        message: 'Message sent successfully'
      }),
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*'
        }
      }
    )
  } catch (error) {
    console.error('Contact form error:', error)
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      }
    )
  }
}

// CORS preflight
export async function onRequestOptions() {
  return new Response(null, {
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    },
  })
}
